<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link
      rel="stylesheet"
      as="style"
      onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&amp;family=Manrope%3Awght%40400%3B500%3B700%3B800&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900"
    />

    <title>result</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <!-- Naver Maps JS + Geocoder submodule -->
    <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=iithl38emp&submodules=geocoder"></script>

</head>
<body>
    <div class="relative flex size-full min-h-screen flex-col bg-white group/design-root overflow-x-hidden" style='font-family: Manrope, "Noto Sans", sans-serif;'>
      <div class="layout-container flex h-full grow flex-col">
        <header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-b-[#f0f2f5] px-10 py-3">
          <div class="flex items-center gap-4 text-[#111418]">
            <div class="size-4">
              <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g clip-path="url(#clip0_6_330)">
                  <path
                    fill-rule="evenodd"
                    clip-rule="evenodd"
                    d="M24 0.757355L47.2426 24L24 47.2426L0.757355 24L24 0.757355ZM21 35.7574V12.2426L9.24264 24L21 35.7574Z"
                    fill="currentColor"
                  ></path>
                </g>
                <defs>
                  <clipPath id="clip0_6_330"><rect width="48" height="48" fill="white"></rect></clipPath>
                </defs>
              </svg>
            </div>
            <h2 class="text-[#111418] text-lg font-bold leading-tight tracking-[-0.015em]">Drawmind</h2>
          </div>
          <div class="flex flex-1 justify-end gap-8">
            <div class="flex items-center gap-9">
              <a class="text-[#111418] text-sm font-medium leading-normal" href="#">Home</a>
              <a class="text-[#111418] text-sm font-medium leading-normal" href="#">About</a>
          <!--<a class="text-[#111418] text-sm font-medium leading-normal" href="#">Services</a>
             <a class="text-[#111418] text-sm font-medium leading-normal" href="#">Contact</a> --> 
            </div>
          </div>
        </header>
                <div class="px-40 flex flex-1 justify-center py-5">
          <div class="layout-content-container flex flex-col max-w-[960px] flex-1">

            <div class="flex flex-col gap-4 px-4 py-6">
              <h2 class="text-[#111418] tracking-light text-[28px] font-bold leading-tight text-center pb-3 pt-5">측정 결과</h2>
              <div class="flex flex-wrap gap-4">
                <div class="flex min-w-72 flex-1 flex-col gap-2 rounded-xl border border-[#dbe0e6] p-6">
                  <p class="text-[#111418] text-base font-medium leading-normal">인지 영역</p>
                  <p class="text-[#111418] tracking-light text-[32px] font-bold leading-tight truncate">평균 점수</p>
                  <div class="grid min-h-[180px] grid-flow-col gap-6 grid-rows-[1fr_auto] items-end justify-items-center px-3">
                    <div class="border-[#60758a] bg-[#f0f2f5] border-t-2 w-full" style="height: 30%;"></div>
                    <p class="text-[#60758a] text-[13px] font-bold leading-normal tracking-[0.015em]">기억력</p>
                    <div class="border-[#60758a] bg-[#f0f2f5] border-t-2 w-full" style="height: 30%;"></div>
                    <p class="text-[#60758a] text-[13px] font-bold leading-normal tracking-[0.015em]">지남력</p>
                    <div class="border-[#60758a] bg-[#f0f2f5] border-t-2 w-full" style="height: 90%;"></div>
                    <p class="text-[#60758a] text-[13px] font-bold leading-normal tracking-[0.015em]">언어영역</p>
                    <div class="border-[#60758a] bg-[#f0f2f5] border-t-2 w-full" style="height: 70%;"></div>
                    <p class="text-[#60758a] text-[13px] font-bold leading-normal tracking-[0.015em]">판단력</p>
                    <div class="border-[#60758a] bg-[#f0f2f5] border-t-2 w-full" style="height: 100%;"></div>
                    <p class="text-[#60758a] text-[13px] font-bold leading-normal tracking-[0.015em]">시공간능력</p>
                  </div>
                </div>
              </div>
              <p class="text-[#111418] text-lg font-normal leading-normal pb-3 pt-1 px-4 text-center">
                인지 평가 결과에 따르면, <strong>기억력</strong>과 <strong>지남력</strong> 영역에서 약간의 어려움이 감지되었습니다. <br>
                인지 건강을 유지하기 위해 이 부분들을 일찍부터 관리하는 것이 중요합니다.
              </p>
            </div>

            <div class="flex flex-col gap-4 px-4 py-6">
              <h2 class="text-[#111418] text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">다음 단계</h2>
              <div class="border border-[#dbe0e6] rounded-xl p-6">
                <p class="text-[#111418] text-lg font-normal leading-normal text-center">
                  인지 건강은 우리 몸처럼 꾸준한 관리가 필요해요. <br>
                  전문가의 도움을 받는 것이 가장 확실하고 안전한 방법입니다. <br><br>
                  <strong>의료 전문가와 상담</strong>: 가까운 병원이나 보건소에서 전문의와 상담해보세요. <br>
                  <strong>조기 발견의 중요성</strong>: 일찍부터 관리하면 인지 능력을 건강하게 유지하는 데 큰 도움이 됩니다.
                </p>
              </div>
            </div>

            <div class="flex flex-col gap-4 px-4 py-6">
              <h2 class="text-[#111418] text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">일상생활에서 실천할 수 있는 방법들</h2>
              <div class="border border-[#dbe0e6] rounded-xl p-6">
                <ul class="list-none p-0 m-0">
                  <li class="text-[#111418] text-lg font-normal leading-normal mb-4">
                    <strong>🧠 인지 훈련 프로그램</strong>: 기억력을 증진시키는 훈련 프로그램에 참여해 보세요.
                  </li>
                  <li class="text-[#111418] text-lg font-normal leading-normal mb-4">
                    <strong>🎨 새로운 취미 생활</strong>: 그림 그리기, 악기 배우기 등 머리를 자극하는 활동을 시작해 보세요.
                  </li>
                  <li class="text-[#111418] text-lg font-normal leading-normal mb-4">
                    <strong>🏃‍♂️ 규칙적인 생활 습관</strong>: 균형 잡힌 식사를 하고, 꾸준히 걷기 운동을 해보세요.
                  </li>
                  <li class="text-[#111418] text-lg font-normal leading-normal">
                    <strong>🗣️ 사회 활동 참여</strong>: 친구분들과 만나 대화하거나, 동호회 활동에 참여해 보세요.
                  </li>
                </ul>
              </div>
            </div>


            <h2 class="text-[#111418] text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">
             주변 지원 센터
            </h2>

                        <div id="map" class="mx-4 rounded-xl border border-[#dbe0e6]" style="height: 420px;"></div>

                        <div id="center-list" class="px-4 py-3 grid gap-3"></div>

            <div class="flex px-4 py-3">
              <div
                class="w-full bg-center bg-no-repeat aspect-video bg-cover rounded-xl object-cover"
                style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuDzH3wSNKos48dF4gJKVP_tdol_zkb6KCtAKgmIeecUvK-aUe9Pq5a45bTJomNi--soSDjN7D-VDMyI_YrqAUMmvuuOvD0ppbwROqm9OkOp2ZEmJNF73indqoIwB6CCEgoeV3-k4KLOLzOIMcQBSAFMySbiRT8m8KrgnMsrMVbp_n3lkLrglOWTwmIO3POUat8k4wv77hIAz-OaWod1rYU9pF2QzMwPTfmM8373ayAcmEV84_1DbmOXcR4T0XU02P280qE-dyq_rw");'
              ></div>
            </div>

            <p class="text-[#111418] text-base font-normal leading-normal pb-3 pt-1 px-4 text-center">
              Find support centers near you that offer resources and programs tailored to cognitive health. These centers provide valuable assistance and guidance for managing
              cognitive changes.
            </p>

            <h2 class="text-[#111418] text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">Importance of Early Intervention</h2>
            <p class="text-[#111418] text-base font-normal leading-normal pb-3 pt-1 px-4 text-center">
              Early detection and treatment of cognitive issues can slow progression and improve quality of life. Regular assessments and proactive management are key to
              maintaining cognitive well-being. Don't hesitate to seek professional advice and support.
            </p>
          </div>
        </div>
      </div>
    </div>

        <script>
      const $ = (sel) => document.querySelector(sel);
      let map;

      // 지도 SDK 로드 확인
      function ensureNaverLoaded() {
        if (typeof naver === "undefined" || !naver.maps) {
          console.error("[NAVER] maps.js가 로드되지 않았습니다. ncpClientId 또는 허용 도메인 설정을 확인하세요.");
          alert("지도를 불러오지 못했습니다. 콘솔 오류를 확인해 주세요.");
          return false;
        }
        return true;
      }

      // 폴백 좌표(서울시청)
      const DEFAULT_CENTER = { lat: 37.5665, lng: 126.9780 };

      // 공통 초기화
      function initMapAt(lat, lng, isFallback) {
        if (!ensureNaverLoaded()) return;

        const center = new naver.maps.LatLng(lat, lng);
        map = new naver.maps.Map('map', { center, zoom: 14 });

        new naver.maps.Marker({
          position: center,
          map,
          title: isFallback ? "기본 위치(서울시청)" : "현재 위치"
        });

        if (isFallback) {
          const listEl = $("#center-list");
          const tip = document.createElement("div");
          tip.className = "text-sm text-[#60758a]";
          tip.textContent = "현재 위치 사용이 거부/실패되어 기본 위치(서울시청)로 안내 중입니다.";
          listEl.prepend(tip);
        }

        loadNearbyCenters(lat, lng);
      }

      // 현재 위치 기반(실패 시 폴백)
      function initMapWithMyLocation() {
        if (!navigator.geolocation) {
          console.warn("지오로케이션 미지원 → 폴백");
          initMapAt(DEFAULT_CENTER.lat, DEFAULT_CENTER.lng, true);
          return;
        }

        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            initMapAt(lat, lng, false);
          },
          (err) => {
            console.error("geolocation error:", err);
            alert("위치 권한을 허용하지 않아 기본 위치로 안내합니다.");
            initMapAt(DEFAULT_CENTER.lat, DEFAULT_CENTER.lng, true);
          },
          { enableHighAccuracy: true, timeout: 10000 }
        );
      }

      function renderCenters(items) {
        const listEl = $("#center-list");
        listEl.innerHTML = "";

        items.forEach((it) => {
          const latlng = new naver.maps.LatLng(it.lat, it.lng);
          const marker = new naver.maps.Marker({ position: latlng, map });
          const info = new naver.maps.InfoWindow({
            content: `
              <div style="padding:8px;max-width:240px;">
                <div style="font-weight:700;margin-bottom:4px;">${it.title}</div>
                <div style="font-size:12px;color:#444;">${it.roadAddress || it.address || ""}</div>
                <div style="font-size:12px;color:#444;">${it.telephone || ""}</div>
                <div style="margin-top:6px;font-size:12px;">거리: ${it.distance_km.toFixed(1)} km</div>
              </div>`
          });
          naver.maps.Event.addListener(marker, "click", () => {
            info.open(map, marker);
          });

          const card = document.createElement("div");
          card.className = "rounded-lg border border-[#dbe0e6] p-3";
          card.innerHTML = `
            <div class="text-sm font-bold">${it.title}</div>
            <div class="text-sm text-[#60758a]">${it.roadAddress || it.address || ""}</div>
            <div class="text-sm">${it.telephone || ""}</div>
            <div class="text-xs text-[#60758a]">약 ${it.distance_km.toFixed(1)} km</div>
          `;
          listEl.appendChild(card);
        });
      }

// 두 지점 사이의 거리를 계산하는 Haversine 공식
function haversine_km(lat1, lon1, lat2, lon2) {
  const R = 6371; // 지구의 반경 (단위: km)
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

async function loadNearbyCenters(lat, lng) {
  try {
    // 공공데이터포털 API 키와 엔드포인트
    const serviceKey = 'rOsGTN3QAVdhOCg8qpAg9Phh8MZLgO7JZZQrTqNGdGOfsnUG9%2F2VNTVGVWaRcfdbAxngGnHsL96lOEbNI48VRg%3D%3D';
    const endpoint = '15138421/v1/uddi:8008b803-2419-4066-a3bb-8449371f3cff';

    // 💡 CORS 오류를 우회하기 위한 프록시 서버 사용
    // https://cors-anywhere.herokuapp.com/ 대신에 allorigins를 사용합니다.
    const proxyUrl = 'https://api.allorigins.win/get?url=';
    const apiUrl = `http://api.odcloud.kr/api/${endpoint}?serviceKey=${serviceKey}&page=1&perPage=1000`; 
    
    // 최종 요청 URL
    const url = `${proxyUrl}${encodeURIComponent(apiUrl)}`;

    const r = await fetch(url);
    if (!r.ok) {
      const txt = await r.text();
      console.error("API error:", r.status, txt);
      alert("센터 정보를 불러오는 중 오류가 발생했습니다.\n" + txt);
      return;
    }
    
    const rawData = await r.json();
    const data = JSON.parse(rawData.contents); // allorigins 프록시의 경우 contents 필드에 실제 JSON이 있음

    const allCenters = data.data || [];

    const filteredCenters = allCenters.map(center => {
      // 위도와 경도 데이터가 없는 경우 건너뛰기
      if (!center.위도 || !center.경도) {
        return null;
      }
      
      const dist = haversine_km(lat, lng, parseFloat(center.위도), parseFloat(center.경도));
      return {
        title: center.치매안심센터명,
        address: center.주소1,
        lat: parseFloat(center.위도),
        lng: parseFloat(center.경도),
        distance_km: dist
      };
    }).filter(center => center !== null).sort((a, b) => a.distance_km - b.distance_km);

    renderCenters(filteredCenters.slice(0, 20)); // 가장 가까운 20개만 표시

  } catch (e) {
    console.error("Failed to load centers:", e);
    alert("센터 정보를 불러오는 중 오류가 발생했습니다.");
  }
}
      // 시작!
      initMapWithMyLocation();
    </script>
</body>
</html>